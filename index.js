(function(){"use strict";function l(a,e,t,s,i,r,u,m){var n=typeof a=="function"?a.options:a;return e&&(n.render=e,n.staticRenderFns=t,n._compiled=!0),n._scopeId="data-v-"+r,{exports:a,options:n}}const o={props:{page:{type:Number,default:1}},data(){return{currentImages:{},originalImages:{},saving:{},images:[],pagination:{page:1,pages:1,total:0,limit:100},totals:{withAltText:0,reviewed:0,total:0},loading:!1,filterMode:null}},computed:{reviewedImagesCount(){return this.totals.reviewed},altTextImagesCount(){return this.totals.withAltText},totalImagesCount(){return this.totals.total},isComplete(){return this.totals.total>0&&this.reviewedImagesCount===this.totals.total},hasAnyChanges(){return Object.keys(this.currentImages).some(a=>this.hasChanges(a))},currentLanguage(){return this.$panel.language?this.$panel.language.code:null},filterOptions(){return[{text:this.$t("medienbaecker.alter.filter.with_alt"),value:"with_alt"},{text:this.$t("medienbaecker.alter.filter.without_alt"),value:"without_alt"},{text:this.$t("medienbaecker.alter.filter.reviewed"),value:"reviewed"},{text:this.$t("medienbaecker.alter.filter.unreviewed"),value:"unreviewed"}]},emptyStateMessage(){return this.$t("medienbaecker.alter.noImages")},groupedImages(){const a={};return this.images.forEach(e=>{const t=e.pageId;a[t]||(a[t]={pageTitle:e.pageTitle,pageId:e.pageId,pagePanelUrl:e.pagePanelUrl,pageSort:e.pageSort,pageStatus:e.pageStatus,hasParentDrafts:e.hasParentDrafts,breadcrumbs:e.breadcrumbs,sortKey:e.sortKey,images:[]}),a[t].images.push(e)}),Object.values(a).sort((e,t)=>e.sortKey.localeCompare(t.sortKey))}},watch:{page(a){this.loadImages(a)},currentLanguage(a,e){if(a!==e&&e!==void 0){if(Object.keys(this.currentImages).some(s=>this.hasChanges(s))&&!confirm(this.$t("medienbaecker.alter.unsavedChanges")))return;this.loadImages(this.page)}}},created(){const e=new URLSearchParams(window.location.search).get("filter");e&&["with_alt","without_alt","reviewed","unreviewed"].includes(e)&&(this.filterMode=e),this.loadImages(this.page)},mounted(){window.panel.events.on("keydown.cmd.s",this.saveAllChanges)},beforeDestroy(){window.panel.events.off("keydown.cmd.s",this.saveAllChanges)},methods:{onFilterChange(a){if(Object.keys(this.currentImages).some(s=>this.hasChanges(s))&&!confirm(this.$t("medienbaecker.alter.unsavedChanges")))return;this.filterMode=a,this.loadImages(1);const t=a?`?filter=${a}`:"";this.$go(`/alter/1${t}`)},onAltTextInput(a,e){const t=e.replace(/[\r\n]+/g," ").trim();this.currentImages[a]&&(this.currentImages[a].alt=t)},onAltTextKeydown(a){a.key==="Enter"&&a.preventDefault()},async loadImages(a=1){this.loading=!0;try{const e=await this.$api.get("alter/images",{page:a,filter:this.filterMode||"all"});this.images=e.images,this.pagination=e.pagination,this.totals=e.totals,this.initializeImageData()}catch(e){console.error("Failed to load images:",e),this.$panel.notification.error("Failed to load images")}finally{this.loading=!1}},initializeImageData(){this.currentImages={},this.originalImages={},this.saving={},this.images.forEach(a=>{const e={alt:a.alt,alt_reviewed:a.alt_reviewed};this.$set(this.originalImages,a.id,{...e}),this.$set(this.currentImages,a.id,{...e}),this.$set(this.saving,a.id,!1)})},onPageChange(a){if(Object.keys(this.currentImages).some(i=>this.hasChanges(i))&&!confirm(this.$t("medienbaecker.alter.unsavedChanges")))return;const t=a.page||a,s=this.filterMode?`?filter=${this.filterMode}`:"";this.$go(`/alter/${t}${s}`)},getImageData(a){return this.currentImages[a]||{alt:"",alt_reviewed:!1}},hasChanges(a){const e=this.currentImages[a],t=this.originalImages[a];return!e||!t?!1:e.alt!==t.alt||e.alt_reviewed!==t.alt_reviewed},async saveImage(a){this.$set(this.saving,a,!0);try{const e=this.currentImages[a],t=this.originalImages[a];if(e.alt!==t.alt&&await this.updateField(a,"alt",e.alt),e.alt_reviewed!==t.alt_reviewed&&await this.updateField(a,"alt_reviewed",e.alt_reviewed?"true":""),e.alt!==t.alt){const s=t.alt&&t.alt.trim()!=="",i=e.alt&&e.alt.trim()!=="";!s&&i?this.totals.withAltText++:s&&!i&&this.totals.withAltText--}e.alt_reviewed!==t.alt_reviewed&&(e.alt_reviewed?this.totals.reviewed++:this.totals.reviewed--),this.$set(this.originalImages,a,{...e}),this.$panel.notification.success(),this.filterMode!==null&&await this.loadImages(this.pagination.page)}catch(e){this.$panel.notification.error(this.$t("medienbaecker.alter.error")),console.error(e)}finally{this.$set(this.saving,a,!1)}},async updateField(a,e,t){const s=await this.$api.post("alter/update",{imageId:a,field:e,value:t});if(s.error)throw new Error(s.error);return s},saveAllChanges(a){a&&a.preventDefault();const e=[];Object.keys(this.currentImages).forEach(t=>{this.hasChanges(t)&&e.push(t)}),e.length!==0&&e.forEach(t=>{this.saveImage(t)})}}};var c=function(){var e=this,t=e._self._c;return t("k-panel-inside",{staticClass:"k-alter-view"},[t("k-header",{scopedSlots:e._u([{key:"buttons",fn:function(){return[t("k-button",{style:{visibility:e.hasAnyChanges?"visible":"hidden"},attrs:{icon:"check",theme:"orange",variant:"filled",size:"sm"},on:{click:e.saveAllChanges}},[e._v(" "+e._s(e.$t("medienbaecker.alter.save"))+" ")]),!e.loading&&e.totalImagesCount>0?t("k-button",{attrs:{element:"span",variant:"filled",size:"sm",icon:"edit"}},[e._v(" "+e._s(`${e.altTextImagesCount}/${e.totalImagesCount}`)+" ")]):e._e(),!e.loading&&e.totalImagesCount>0?t("k-button",{attrs:{element:"span",variant:"filled",size:"sm",icon:"check",theme:e.isComplete?"positive":null}},[e._v(" "+e._s(`${e.reviewedImagesCount}/${e.totalImagesCount}`)+" ")]):e._e(),e.currentLanguage?t("k-button",{attrs:{element:"span",variant:"filled",size:"sm"}},[e._v(" "+e._s(e.currentLanguage.toUpperCase())+" ")]):e._e()]},proxy:!0}])},[e._v(" "+e._s(e.$t("medienbaecker.alter.title"))+" ")]),t("div",{staticClass:"k-alter-filter"},[t("k-select-field",{staticClass:"k-alter-filter__select",attrs:{label:e.$t("medienbaecker.alter.filter.label"),options:e.filterOptions,value:e.filterMode,placeholder:e.$t("medienbaecker.alter.filter.all")},on:{input:e.onFilterChange}})],1),e.loading?t("div",{staticClass:"k-loader"},[t("k-loader")],1):e.images.length===0?t("div",{staticClass:"k-empty"},[t("k-text",[e._v(e._s(e.emptyStateMessage))])],1):t("div",[e._l(e.groupedImages,function(s){return t("div",{key:s.pageId,staticClass:"page-group"},[t("div",{staticClass:"page-group__header"},[t("k-text",{staticClass:"page-group__breadcrumb"},[e._l(s.breadcrumbs,function(i,r){return[t("k-link",{staticClass:"page-group__breadcrumb-link",attrs:{to:i.panelUrl}},[t("strong",[e._v(e._s(i.title))])]),r<s.breadcrumbs.length-1?t("span",[e._v(" â†’ ")]):e._e()]})],2),t("div",{staticClass:"page-group__badges"},[s.pageStatus==="draft"||s.hasParentDrafts?t("k-button",{attrs:{element:"span",variant:"filled",size:"sm",theme:"negative"}},[e._v(" "+e._s(e.$t("page.status.draft"))+" ")]):e._e(),t("k-button",{attrs:{element:"span",variant:"filled",size:"sm"}},[e._v(" "+e._s(s.images.length)+" "+e._s(s.images.length===1?e.$t("medienbaecker.alter.image"):e.$t("medienbaecker.alter.images"))+" ")])],1)],1),t("k-grid",{staticClass:"page-group__grid",staticStyle:{"--columns":"2",gap:"1rem"}},e._l(s.images,function(i){return t("div",{key:i.id,staticClass:"alt-review-card",class:{"alt-review-card--has-changes":e.currentImages[i.id]&&e.hasChanges(i.id)}},[t("k-image-frame",{attrs:{src:i.thumbUrl,alt:e.getImageData(i.id).alt,back:"pattern",ratio:"3/2"}}),t("div",{staticClass:"alt-review-card__content"},[t("k-text",{staticClass:"alt-review-card__filename"},[t("k-link",{staticClass:"alt-review-card__filename-link",attrs:{to:i.panelUrl}},[t("strong",[e._v(e._s(i.filename))])])],1),t("k-textarea-field",{staticClass:"alt-review-card__alt-input",attrs:{value:e.currentImages[i.id]?e.currentImages[i.id].alt:"",placeholder:e.$t("medienbaecker.alter.noAltText"),buttons:!1},on:{input:function(r){return e.onAltTextInput(i.id,r)}},nativeOn:{keydown:function(r){return e.onAltTextKeydown.apply(null,arguments)}}}),t("label",{staticClass:"alt-review-card__checkbox"},[t("input",{staticClass:"alt-review-card__checkbox-input",attrs:{type:"checkbox"},domProps:{checked:e.getImageData(i.id).alt_reviewed},on:{change:function(r){return e.$set(e.currentImages[i.id],"alt_reviewed",r.target.checked)}}}),t("span",{staticClass:"alt-review-card__checkbox-label"},[e._v(e._s(e.$t("medienbaecker.alter.reviewed")))])])],1)],1)}),0)],1)}),e.pagination.total>e.pagination.limit?t("k-pagination",{staticStyle:{"margin-top":"2rem"},attrs:{page:e.pagination.page,total:e.pagination.total,limit:e.pagination.limit,details:!0},on:{paginate:e.onPageChange}}):e._e()],2)],1)},d=[],h=l(o,c,d,!1,null,"14b4f1be");const g=h.exports;panel.plugin("medienbaecker/alter",{components:{"k-alter-view":g}})})();
