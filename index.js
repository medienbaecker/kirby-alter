(function(){"use strict";function l(t,e,a,s,r,n,h,m){var i=typeof t=="function"?t.options:t;return e&&(i.render=e,i.staticRenderFns=a,i._compiled=!0),i._scopeId="data-v-"+n,{exports:t,options:i}}const o={props:{page:{type:Number,default:1},maxLength:{type:[Number,Boolean],default:!1}},data(){return{currentImages:{},originalImages:{},saving:{},images:[],pagination:{page:1,pages:1,total:0,limit:100},totals:{withAltText:0,reviewed:0,total:0},loading:!1,filterMode:null,hasLoadedOnce:!1}},computed:{reviewedImagesCount(){return this.totals.reviewed},altTextImagesCount(){return this.totals.withAltText},totalImagesCount(){return this.totals.total},isComplete(){return this.totals.total>0&&this.reviewedImagesCount===this.totals.total},hasAnyChanges(){return Object.keys(this.currentImages).some(t=>this.hasChanges(t))},currentLanguage(){return this.$panel.language?this.$panel.language.code:null},languages(){return this.$panel.languages||[]},currentFilterLabel(){if(this.filterMode===null)return this.$t("medienbaecker.alter.filter.all");const t=this.filterOptions.find(e=>e.value===this.filterMode);return t?t.text:this.$t("medienbaecker.alter.filter.all")},filterOptions(){return[{text:this.$t("medienbaecker.alter.filter.with_alt"),value:"with_alt"},{text:this.$t("medienbaecker.alter.filter.without_alt"),value:"without_alt"},{text:this.$t("medienbaecker.alter.filter.reviewed"),value:"reviewed"},{text:this.$t("medienbaecker.alter.filter.unreviewed"),value:"unreviewed"}]},emptyStateMessage(){return this.$t("medienbaecker.alter.noImages")},groupedImages(){const t={};return this.images.forEach(e=>{const a=e.pageId;t[a]||(t[a]={pageTitle:e.pageTitle,pageId:e.pageId,pagePanelUrl:e.pagePanelUrl,pageSort:e.pageSort,pageStatus:e.pageStatus,hasParentDrafts:e.hasParentDrafts,breadcrumbs:e.breadcrumbs,sortKey:e.sortKey,images:[]}),t[a].images.push(e)}),Object.values(t).sort((e,a)=>e.sortKey.localeCompare(a.sortKey))}},watch:{page(t){this.loadImages(t)},currentLanguage(t,e){if(t!==e&&e!==void 0){if(this.hasAnyChanges&&!confirm(this.$t("medienbaecker.alter.unsavedChanges")))return;this.loadImages(this.page)}}},created(){const e=new URLSearchParams(window.location.search).get("filter");e&&["with_alt","without_alt","reviewed","unreviewed"].includes(e)&&(this.filterMode=e),this.loadImages(this.page)},mounted(){window.panel.events.on("keydown.cmd.s",this.saveAllChanges)},beforeDestroy(){window.panel.events.off("keydown.cmd.s",this.saveAllChanges)},methods:{hasChanges(t){const e=this.currentImages[t],a=this.originalImages[t];return!e||!a?!1:e.alt!==a.alt||e.alt_reviewed!==a.alt_reviewed},getImageData(t){return this.currentImages[t]||{alt:"",alt_reviewed:!1}},cardTheme(t){return this.getImageData(t),this.hasChanges(t)?"info":null},cardStyle(t){return this.cardTheme(t)==="info"?{"--item-color-back":"light-dark(var(--color-orange-250), var(--color-orange-800))","--item-color-icon":"var(--color-orange-600)","border-color":"var(--color-orange-300)"}:{}},formatItems(t){return t.map(e=>({...e,text:e.filename,image:{src:e.thumbUrl,back:"pattern",ratio:"3/2"}}))},formatBreadcrumbs(t){return t.map(e=>({text:e.title||e.label,label:e.label||e.title,link:e.panelUrl||e.link}))},onFilterChange(t){if(this.hasAnyChanges&&!confirm(this.$t("medienbaecker.alter.unsavedChanges")))return;this.filterMode=t,this.loadImages(1);const e=t?`?filter=${t}`:"";this.$go(`/alter/1${e}`)},onLanguageChange(t){this.hasAnyChanges&&!confirm(this.$t("medienbaecker.alter.unsavedChanges"))||(this.$panel.language=this.$panel.languages.find(e=>e.code===t),this.loadImages(this.page))},onAltTextInput(t,e){const a=e.replace(/[\r\n]+/g," ").trim();this.currentImages[t]&&this.$set(this.currentImages[t],"alt",a)},onAltTextKeydown(t){t.key==="Enter"&&t.preventDefault()},onReviewChange(t,e){this.currentImages[t]&&this.$set(this.currentImages[t],"alt_reviewed",e)},async loadImages(t=1){this.loading=!0;try{const e=await this.$api.get("alter/images",{page:t,filter:this.filterMode||"all"});this.images=e.images,this.pagination=e.pagination,this.totals=e.totals,this.initializeImageData(),this.hasLoadedOnce=!0}catch(e){console.error("Failed to load images:",e),this.$panel.notification.error("Failed to load images")}finally{this.loading=!1}},initializeImageData(){this.currentImages={},this.originalImages={},this.saving={},this.images.forEach(t=>{const e={alt:t.alt,alt_reviewed:t.alt_reviewed};this.$set(this.originalImages,t.id,{...e}),this.$set(this.currentImages,t.id,{...e}),this.$set(this.saving,t.id,!1)})},onPageChange(t){if(this.hasAnyChanges&&!confirm(this.$t("medienbaecker.alter.unsavedChanges")))return;const e=t.page||t,a=this.filterMode?`?filter=${this.filterMode}`:"";this.$go(`/alter/${e}${a}`)},async saveImage(t){this.$set(this.saving,t,!0);try{const e=this.currentImages[t],a=this.originalImages[t];if(e.alt!==a.alt&&await this.updateField(t,"alt",e.alt),e.alt_reviewed!==a.alt_reviewed&&await this.updateField(t,"alt_reviewed",e.alt_reviewed?"true":""),e.alt!==a.alt){const s=a.alt&&a.alt.trim()!=="",r=e.alt&&e.alt.trim()!=="";!s&&r?this.totals.withAltText++:s&&!r&&this.totals.withAltText--}e.alt_reviewed!==a.alt_reviewed&&(e.alt_reviewed?this.totals.reviewed++:this.totals.reviewed--),this.$set(this.originalImages,t,{...e}),this.$panel.notification.success()}catch(e){this.$panel.notification.error(this.$t("medienbaecker.alter.error")),console.error(e)}finally{this.$set(this.saving,t,!1)}},async updateField(t,e,a){const s=await this.$api.post("alter/update",{imageId:t,field:e,value:a});if(s.error)throw new Error(s.error);return s},async saveAllChanges(t){t&&t.preventDefault();const e=Object.keys(this.currentImages).filter(a=>this.hasChanges(a));e.length!==0&&await Promise.all(e.map(a=>this.saveImage(a)))},discardImage(t){const e=this.originalImages[t];e&&this.$set(this.currentImages,t,{...e})},discardChanges(){Object.keys(this.currentImages).forEach(t=>{const e=this.originalImages[t];e&&this.$set(this.currentImages,t,{...e})})}}};var c=function(){var e=this,a=e._self._c;return a("k-panel-inside",{staticClass:"k-alter-view"},[a("k-header",{scopedSlots:e._u([{key:"buttons",fn:function(){return[a("div",{staticClass:"k-alter-filter"},[a("k-button",{attrs:{dropdown:!0,icon:"filter",variant:"filled",size:"sm",text:e.currentFilterLabel},on:{click:function(s){return e.$refs.filterDropdown.toggle()}}}),a("k-dropdown-content",{ref:"filterDropdown",attrs:{"align-x":"end"}},[a("k-dropdown-item",{attrs:{current:e.filterMode===null},on:{click:function(s){return e.onFilterChange(null)}}},[e._v(" "+e._s(e.$t("medienbaecker.alter.filter.all"))+" ")]),e._l(e.filterOptions,function(s){return a("k-dropdown-item",{key:s.value,attrs:{current:e.filterMode===s.value},on:{click:function(r){return e.onFilterChange(s.value)}}},[e._v(" "+e._s(s.text)+" ")])})],2)],1),e.totalImagesCount>0?a("k-button",{attrs:{element:"span",variant:"filled",size:"sm",icon:"edit"}},[e._v(" "+e._s(`${e.altTextImagesCount}/${e.totalImagesCount}`)+" ")]):e._e(),e.totalImagesCount>0?a("k-button",{attrs:{element:"span",variant:"filled",size:"sm",icon:"check",theme:e.isComplete?"positive":null}},[e._v(" "+e._s(`${e.reviewedImagesCount}/${e.totalImagesCount}`)+" ")]):e._e(),e.languages.length>1?a("div",{staticClass:"k-alter-language"},[a("k-button",{attrs:{dropdown:!0,icon:"translate",variant:"filled",size:"sm",text:e.currentLanguage?e.currentLanguage.toUpperCase():""},on:{click:function(s){return e.$refs.languageDropdown.toggle()}}}),a("k-dropdown-content",{ref:"languageDropdown",attrs:{"align-x":"end"}},e._l(e.languages,function(s){return a("k-dropdown-item",{key:s.code,attrs:{current:e.currentLanguage===s.code},on:{click:function(r){return e.onLanguageChange(s.code)}}},[e._v(" "+e._s(s.name)+" "),a("span",{staticClass:"k-alter-language-code"},[e._v(e._s(s.code.toUpperCase()))])])}),1)],1):e._e(),e.hasAnyChanges?a("div",{staticClass:"k-form-controls"},[a("div",{staticClass:"k-button-group",attrs:{"data-layout":"collapsed"}},[a("k-button",{attrs:{icon:"undo",variant:"filled",theme:"notice",size:"sm"},on:{click:e.discardChanges}},[e._v(" "+e._s(e.$t("discard"))+" ")]),a("k-button",{attrs:{icon:"check",theme:"notice",variant:"filled",size:"sm"},on:{click:e.saveAllChanges}},[e._v(" "+e._s(e.$t("medienbaecker.alter.save"))+" ")])],1)]):e._e()]},proxy:!0}])},[e._v(" "+e._s(e.$t("medienbaecker.alter.title"))+" ")]),e.hasLoadedOnce?e.images.length===0?a("div",{staticClass:"k-empty"},[a("k-text",[e._v(e._s(e.emptyStateMessage))])],1):a("div",{staticClass:"k-alter-content"},[e._l(e.groupedImages,function(s){return a("div",{key:s.pageId,staticClass:"page-group"},[a("div",{staticClass:"page-group__header"},[a("k-breadcrumb",{staticClass:"page-group__breadcrumb",attrs:{crumbs:e.formatBreadcrumbs(s.breadcrumbs)}}),a("div",{staticClass:"page-group__badges"},[s.pageStatus==="draft"||s.hasParentDrafts?a("k-button",{attrs:{element:"span",variant:"filled",size:"sm",theme:"negative"}},[e._v(" "+e._s(e.$t("page.status.draft"))+" ")]):e._e(),a("k-button",{attrs:{element:"span",variant:"filled",size:"sm"}},[e._v(" "+e._s(s.images.length)+" "+e._s(s.images.length===1?e.$t("medienbaecker.alter.image"):e.$t("medienbaecker.alter.images"))+" ")])],1)],1),a("k-items",{attrs:{items:e.formatItems(s.images),layout:"cards",size:"huge",link:!1},scopedSlots:e._u([{key:"default",fn:function({item:r}){return[a("div",{class:["k-alter-card","k-item","k-cards-item"],style:e.cardStyle(r.id),attrs:{"data-layout":"cards","data-theme":e.cardTheme(r.id),"data-has-image":"true","data-selecting":e.hasChanges(r.id),"data-selectable":"true"}},[a("k-link",{staticClass:"k-alter-card__image-link",attrs:{to:r.panelUrl}},[a("k-image-frame",{attrs:{src:r.thumbUrl,alt:e.getImageData(r.id).alt,back:"pattern",ratio:"3/2"}})],1),a("div",{staticClass:"k-alter-card__content k-item-content"},[a("k-textarea-field",{staticClass:"k-alter-card__alt-input",attrs:{label:r.filename,value:e.currentImages[r.id]?e.currentImages[r.id].alt:"",placeholder:e.$t("medienbaecker.alter.noAltText"),buttons:!1,counter:!0,maxlength:e.maxLength||null,size:"small"},on:{input:function(n){return e.onAltTextInput(r.id,n)}},nativeOn:{keydown:function(n){return e.onAltTextKeydown.apply(null,arguments)}}}),e.hasChanges(r.id)?a("div",{staticClass:"k-alter-card__actions k-form-controls"},[a("div",{staticClass:"k-button-group",attrs:{"data-layout":"collapsed"}},[a("k-button",{attrs:{icon:"undo",variant:"filled",theme:"notice",size:"sm"},on:{click:function(n){return e.discardImage(r.id)}}},[e._v(" "+e._s(e.$t("discard"))+" ")]),a("k-button",{attrs:{icon:"check",variant:"filled",theme:"notice",size:"sm"},on:{click:function(n){return e.saveImage(r.id)}}},[e._v(" "+e._s(e.$t("save"))+" ")])],1)]):e._e()],1)],1)]}}],null,!0)})],1)}),e.pagination.total>e.pagination.limit?a("k-pagination",{staticStyle:{"margin-top":"2rem"},attrs:{page:e.pagination.page,total:e.pagination.total,limit:e.pagination.limit,details:!0},on:{paginate:e.onPageChange}}):e._e()],2):a("div",{staticClass:"k-loader-container"},[a("k-loader")],1)],1)},d=[],u=l(o,c,d,!1,null,"693926ad");const g=u.exports;panel.plugin("medienbaecker/alter",{components:{"k-alter-view":g}})})();
