(function(){"use strict";function c(e,t,a,s,i,n,l,o){var r=typeof e=="function"?e.options:e;return t&&(r.render=t,r.staticRenderFns=a,r._compiled=!0),r._scopeId="data-v-"+n,{exports:e,options:r}}const u={props:{page:{type:Number,default:1},maxLength:{type:[Number,Boolean],default:!1}},data(){return{images:[],pagination:{page:1,pages:1,total:0,limit:100},totals:{unsaved:0,saved:0,total:0},currentImages:{},originalImages:{},saving:{},altSaveTimeouts:{},loading:!1,filterMode:null,hasLoadedOnce:!1,activeImageId:null,lastCmdSHandledAt:0}},computed:{savedImagesCount(){return this.totals.saved},unsavedImagesCount(){return this.totals.unsaved},totalImagesCount(){return this.totals.total},isComplete(){return this.totals.total>0&&this.savedImagesCount===this.totals.total},hasAnyChanges(){return Object.keys(this.currentImages).some(e=>this.hasChanges(e))},currentLanguage(){return this.$panel.language?this.$panel.language.code:null},languages(){return this.$panel.languages||[]},currentFilterLabel(){if(this.filterMode===null)return this.$t("medienbaecker.alter.filter.all");const e=this.filterOptions.find(t=>t.value===this.filterMode);return e?e.text:this.$t("medienbaecker.alter.filter.all")},filterOptions(){return[{text:this.$t("medienbaecker.alter.filter.saved"),value:"with_alt"},{text:this.$t("medienbaecker.alter.filter.unsaved"),value:"unsaved"},{text:this.$t("medienbaecker.alter.filter.empty"),value:"without_alt"}]},emptyStateMessage(){return this.$t("medienbaecker.alter.noImages")},groupedImages(){const e={};return this.images.forEach(t=>{const a=t.pageId;e[a]||(e[a]={pageTitle:t.pageTitle,pageId:t.pageId,pagePanelUrl:t.pagePanelUrl,pageSort:t.pageSort,pageStatus:t.pageStatus,hasParentDrafts:t.hasParentDrafts,breadcrumbs:t.breadcrumbs,sortKey:t.sortKey,images:[]}),e[a].images.push(t)}),Object.values(e).sort((t,a)=>t.sortKey.localeCompare(a.sortKey))},unsavedCountByPageId(){const e=Object.create(null);for(const t of this.images){const a=t.pageId;e[a]==null&&(e[a]=0),this.hasChanges(t.id)&&(e[a]+=1)}return e}},watch:{page(e){this.flushAltDraftSaves().finally(()=>this.loadImages(e))},currentLanguage(e,t){e!==t&&t!==void 0&&this.flushAltDraftSaves().finally(()=>this.loadImages(this.page))}},created(){const t=new URLSearchParams(window.location.search).get("filter");t&&["with_alt","without_alt","unsaved"].includes(t)&&(this.filterMode=t),this.loadImages(this.page)},mounted(){window.panel.events.on("keydown.cmd.s",this.onCmdS)},beforeDestroy(){window.panel.events.off("keydown.cmd.s",this.onCmdS)},methods:{pageStatusUi(e){const t=e.pageStatus,s={draft:{icon:"status-draft",theme:"negative-icon",text:this.$t("page.status.draft")},unlisted:{icon:"status-unlisted",theme:"notice-icon",text:this.$t("page.status.unlisted")},listed:{icon:"status-listed",theme:"positive-icon",text:this.$t("page.status.listed")}}[t]??{icon:"circle",theme:null,text:t};return s.title=`Status: ${s.text}`,s},badgeForPage(e){const t=this.unsavedCountByPageId[e]||0;return t>0?{theme:"orange",text:t}:null},setActiveImage(e){this.activeImageId=e},getActiveImageIdFromDom(){var a;const e=document.activeElement;if(!e||!e.closest)return null;const t=e.closest("[data-image-id]");return((a=t==null?void 0:t.dataset)==null?void 0:a.imageId)||null},async onCmdS(e){var a,s;if(Date.now()-this.lastCmdSHandledAt<250){(a=e==null?void 0:e.preventDefault)==null||a.call(e);return}(s=e==null?void 0:e.preventDefault)==null||s.call(e);const t=this.activeImageId||this.getActiveImageIdFromDom();if(t&&this.hasChanges(t)){await this.saveImage(t);return}await this.saveAllChanges(e)},onAltTextKeydown(e,t){if(this.setActiveImage(e),(t.metaKey||t.ctrlKey)&&String(t.key).toLowerCase()==="s"){t.preventDefault(),t.stopPropagation(),this.lastCmdSHandledAt=Date.now(),this.saveImage(e);return}t.key==="Enter"&&t.preventDefault()},hasChanges(e){const t=this.currentImages[e],a=this.originalImages[e];return!t||!a?!1:t.alt!==a.alt},getImageData(e){return this.currentImages[e]||{alt:""}},async saveAltDraft(e){var s;const t=this.getImageById(e);if(!t)return;const a=(((s=this.currentImages[e])==null?void 0:s.alt)??"").trim();try{const i=await this.$api.post("alter/update",{imageId:t.id,field:"alt",value:a});i&&i.error&&this.$panel.notification.error(i.error||this.$t("medienbaecker.alter.error"))}catch(i){this.$panel.notification.error(this.$t("medienbaecker.alter.error")),console.error("Draft save failed",i)}},scheduleAltDraftSave(e){this.altSaveTimeouts[e]&&clearTimeout(this.altSaveTimeouts[e]),this.altSaveTimeouts[e]=setTimeout(async()=>{try{await this.saveAltDraft(e)}finally{this.altSaveTimeouts[e]=null}},200)},async flushAltDraftSaves(){const e=Object.keys(this.altSaveTimeouts).filter(t=>this.altSaveTimeouts[t]);if(e.length!==0){for(const t of e)clearTimeout(this.altSaveTimeouts[t]),this.altSaveTimeouts[t]=null;await Promise.all(e.map(t=>this.saveAltDraft(t)))}},async flushAltDraftSaveFor(e){var a;const t=(a=this.altSaveTimeouts)==null?void 0:a[e];t&&(clearTimeout(t),this.altSaveTimeouts[e]=null,await this.saveAltDraft(e))},async onFilterChange(e){await this.flushAltDraftSaves(),this.filterMode=e,this.loadImages(1);const t=e?`?filter=${e}`:"";this.$go(`/alter/1${t}`)},async onLanguageChange(e){await this.flushAltDraftSaves(),this.$panel.language=this.$panel.languages.find(t=>t.code===e),this.loadImages(this.page)},async onPageChange(e){await this.flushAltDraftSaves();const t=e.page||e,a=this.filterMode?`?filter=${this.filterMode}`:"";this.$go(`/alter/${t}${a}`)},onAltTextInput(e,t){const a=t.replace(/[\r\n]+/g," ").trim();if(this.currentImages[e]){const s=this.hasChanges(e);this.$set(this.currentImages[e],"alt",a);const i=this.hasChanges(e);this.updateUnsavedTotals(s,i),this.scheduleAltDraftSave(e)}},async loadImages(e=1){this.loading=!0;try{const t=await this.$api.get("alter/images",{page:e,filter:this.filterMode||"all"});this.images=t.images,this.pagination=t.pagination,this.totals=t.totals,this.initializeImageData(),this.hasLoadedOnce=!0}catch(t){console.error("Failed to load images:",t),this.$panel.notification.error("Failed to load images")}finally{this.loading=!1}},initializeImageData(){this.currentImages={},this.originalImages={},this.saving={},this.images.forEach(e=>{const t={alt:e.alt||""},a={alt:e.altOriginal||""};this.$set(this.originalImages,e.id,{...a}),this.$set(this.currentImages,e.id,{...t}),this.$set(this.saving,e.id,!1)})},formatItems(e){return e.map(t=>({...t,text:t.filename,image:{src:t.thumbUrl,back:"pattern",ratio:"3/2"}}))},formatBreadcrumbs(e){return e.map(t=>({text:t.title||t.label,label:t.label||t.title,link:t.panelUrl||t.link}))},getImageById(e){return this.images.find(t=>t.id===e)},updateUnsavedTotals(e,t){e!==t&&(this.totals.unsaved+=t?1:-1)},updateSavedTotals(e,t){const a=e&&e.trim()!=="",s=t&&t.trim()!=="";a!==s&&(this.totals.saved+=s?1:-1)},async saveImage(e){await this.flushAltDraftSaveFor(e),this.$set(this.saving,e,!0);try{const t=this.getImageById(e),a=this.currentImages[e],s=this.originalImages[e],i=this.hasChanges(e);if(!t||!a)return;const n=await this.$api.post("alter/publish",{imageId:t.id,alt:a.alt});if(n.error)throw new Error(n.error);s&&this.updateSavedTotals(s.alt,a.alt),this.$set(this.originalImages,e,{alt:a.alt}),this.updateUnsavedTotals(i,!1),this.$panel.notification.success()}catch(t){this.$panel.notification.error(this.$t("medienbaecker.alter.error")),console.error(t)}finally{this.$set(this.saving,e,!1)}},async saveAllChanges(e){e&&e.preventDefault(),await this.flushAltDraftSaves();const t=Object.keys(this.currentImages).filter(a=>this.hasChanges(a));t.length!==0&&await Promise.all(t.map(a=>this.saveImage(a)))},async discardImage(e){const t=this.getImageById(e),a=this.originalImages[e],s=this.currentImages[e];if(!t||!a||!s)return;await this.flushAltDraftSaveFor(e);const i=this.hasChanges(e);this.$set(this.currentImages,e,{...a}),this.updateUnsavedTotals(i,this.hasChanges(e));try{await this.$api.post("alter/discard",{imageId:t.id});const l=(await this.$api.get("alter/images",{page:this.page,filter:this.filterMode||"all"})).images.find(o=>o.id===e);l&&(this.$set(this.originalImages,e,{alt:l.altOriginal||""}),this.$set(this.currentImages,e,{alt:l.alt||""}))}catch(n){this.$panel.notification.error(this.$t("medienbaecker.alter.error")),console.error(n)}},async discardChanges(){await this.flushAltDraftSaves();const e=Object.keys(this.currentImages).filter(t=>this.hasChanges(t));e.length!==0&&await Promise.all(e.map(t=>this.discardImage(t)))}}};var h=function(){var t=this,a=t._self._c;return a("k-panel-inside",[a("k-header",{scopedSlots:t._u([{key:"buttons",fn:function(){return[a("k-button",{attrs:{dropdown:!0,icon:"filter",variant:"filled",size:"sm",text:t.currentFilterLabel},on:{click:function(s){return t.$refs.filterDropdown.toggle()}}}),a("k-dropdown-content",{ref:"filterDropdown",attrs:{"align-x":"end"}},[a("k-dropdown-item",{attrs:{current:t.filterMode===null},on:{click:function(s){return t.onFilterChange(null)}}},[t._v(" "+t._s(t.$t("medienbaecker.alter.filter.all"))+" ")]),t._l(t.filterOptions,function(s){return a("k-dropdown-item",{key:s.value,attrs:{current:t.filterMode===s.value},on:{click:function(i){return t.onFilterChange(s.value)}}},[t._v(" "+t._s(s.text)+" ")])})],2),t.totalImagesCount>0?a("k-button",{attrs:{variant:"filled",size:"sm",icon:"edit",element:"span"}},[t._v(" "+t._s(`${t.unsavedImagesCount}/${t.totalImagesCount}`)+" ")]):t._e(),t.totalImagesCount>0?a("k-button",{attrs:{variant:"filled",size:"sm",icon:"check",element:"span",theme:t.isComplete?"positive":null}},[t._v(" "+t._s(`${t.savedImagesCount}/${t.totalImagesCount}`)+" ")]):t._e(),t.languages.length>1?[a("k-button",{attrs:{dropdown:!0,icon:"translate",variant:"filled",size:"sm",text:t.currentLanguage?t.currentLanguage.toUpperCase():""},on:{click:function(s){return t.$refs.languageDropdown.toggle()}}}),a("k-dropdown-content",{ref:"languageDropdown",attrs:{"align-x":"end"}},t._l(t.languages,function(s){return a("k-dropdown-item",{key:s.code,attrs:{current:t.currentLanguage===s.code},on:{click:function(i){return t.onLanguageChange(s.code)}}},[t._v(" "+t._s(s.name)+" "),a("span",[t._v(t._s(s.code.toUpperCase()))])])}),1)]:t._e(),t.hasAnyChanges?a("k-form-controls",[a("k-button-group",{attrs:{layout:"collapsed"}},[a("k-button",{attrs:{icon:"undo",variant:"filled",theme:"notice",size:"sm"},on:{click:t.discardChanges}},[t._v(" "+t._s(t.$t("discard"))+" ")]),a("k-button",{attrs:{icon:"check",theme:"notice",variant:"filled",size:"sm"},on:{click:t.saveAllChanges}},[t._v(" "+t._s(t.$t("medienbaecker.alter.save"))+" ")])],1)],1):t._e()]},proxy:!0}])},[t._v(" "+t._s(t.$t("medienbaecker.alter.title"))+" ")]),t.hasLoadedOnce?t.images.length===0?a("div",{staticClass:"k-empty"},[a("k-text",[t._v(t._s(t.emptyStateMessage))])],1):[t._l(t.groupedImages,function(s){return a("k-section",{key:s.pageId},[a("header",{staticClass:"k-section-header"},[a("k-breadcrumb",{attrs:{crumbs:t.formatBreadcrumbs(s.breadcrumbs)}}),a("k-button-group",{staticClass:"k-section-buttons"},[a("k-button",{attrs:{variant:"filled",size:"sm",element:"span",badge:t.badgeForPage(s.pageId)}},[t._v(" "+t._s(s.images.length)+" "+t._s(s.images.length===1?t.$t("medienbaecker.alter.image"):t.$t("medienbaecker.alter.images"))+" ")]),s.hasParentDrafts||s.pageStatus?a("k-button",{attrs:{element:"span",variant:"filled",size:"sm",icon:s.hasParentDrafts?"status-draft":t.pageStatusUi(s).icon,theme:s.hasParentDrafts?"negative-icon":t.pageStatusUi(s).theme,title:s.hasParentDrafts?t.$t("medienbaecker.alter.parentDraft"):t.pageStatusUi(s).title,responsive:!0}},[t._v(" "+t._s(s.hasParentDrafts?t.$t("page.status.draft"):t.pageStatusUi(s).text)+" ")]):t._e()],1)],1),a("k-items",{attrs:{items:t.formatItems(s.images),layout:"cards",size:"huge",link:!1},scopedSlots:t._u([{key:"default",fn:function({item:i}){return[a("div",{staticClass:"k-item k-cards-item",attrs:{"data-image-id":i.id}},[a("k-link",{attrs:{to:i.panelUrl}},[a("k-image-frame",{attrs:{src:i.thumbUrl,alt:t.getImageData(i.id).alt,back:"pattern",ratio:"3/2"}})],1),a("div",{staticClass:"k-item-content"},[a("k-textarea-field",{attrs:{label:i.filename,name:"alt",type:"textarea",value:t.currentImages[i.id]?t.currentImages[i.id].alt:"",placeholder:t.$t("medienbaecker.alter.noAltText"),buttons:!1,counter:!0,maxlength:t.maxLength||null,size:"small"},on:{input:function(n){return t.onAltTextInput(i.id,n)}},nativeOn:{focusin:function(n){return t.setActiveImage(i.id)},mousedown:function(n){return t.setActiveImage(i.id)},keydown:function(n){return t.onAltTextKeydown(i.id,n)}}}),t.hasChanges(i.id)?a("div",{staticClass:"k-form-controls"},[a("k-button-group",{attrs:{layout:"collapsed"}},[a("k-button",{attrs:{icon:"undo",variant:"filled",theme:"notice",size:"sm"},on:{click:function(n){return t.discardImage(i.id)}}},[t._v(" "+t._s(t.$t("discard"))+" ")]),a("k-button",{attrs:{icon:"check",variant:"filled",theme:"notice",size:"sm"},on:{click:function(n){return t.saveImage(i.id)}}},[t._v(" "+t._s(t.$t("save"))+" ")])],1)],1):t._e()],1)],1)]}}],null,!0)})],1)}),t.pagination.total>t.pagination.limit?a("k-pagination",{attrs:{page:t.pagination.page,total:t.pagination.total,limit:t.pagination.limit,details:!0},on:{paginate:t.onPageChange}}):t._e()]:a("div",{staticClass:"k-loader-container"},[a("k-loader")],1)],2)},d=[],g=c(u,h,d,!1,null,"73e4ab3a");const f=g.exports;panel.plugin("medienbaecker/alter",{components:{"k-alter-view":f}})})();
